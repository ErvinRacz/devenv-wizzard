---
- name: Install packages on Ubuntu
  hosts: localhost
  vars:
     - go_version: 1.23.3
     - nvm_version: 0.40.0
  become: true

  tasks:
    - name: Update the apt package index
      apt:
        update_cache: yes

    - name: Update or upgrade packages
      apt:
        name: "{{ item }}"
        state: latest  # Ensure the latest version is installed
      loop:
        - qemu-system-x86
        - qemu-utils
        - make
        - jq
        - ripgrep

    - name: Install packages
      apt:
        name: "{{ item }}"
        state: present  # Ensure package does not get upgraded if already present
      loop:
        - neovim

    # Install Docker

    - name: Install Docker
      block:
        - name: Add an Apt signing key, uses whichever key is at the URL
          ansible.builtin.apt_key:
            url: https://download.docker.com/linux/ubuntu/gpg
            state: present

        - name: Add Docker repository
          apt_repository:
            repo: deb https://download.docker.com/linux/ubuntu noble stable
            state: present

        - name: Install Docker
          apt:
            name: docker-ce
            state: present
            update_cache: yes

        - name: Start Docker service
          service:
            name: docker
            state: started
            enabled: yes

    # Install Go

    - stat:
        path: "/usr/local/go/bin/go"
      register: go_installed

    - name: Install Go
      block:
        - name: Download Go tar file
          command: wget https://go.dev/dl/go{{go_version}}.linux-amd64.tar.gz

        - name: Delete previous installation
          command: rm -rf /usr/local/go

        - name: Extract and move new Go folder to /usr/local
          command: tar -C /usr/local -xzf go{{go_version}}.linux-amd64.tar.gz

        - name: Delete downloaded tar file
          shell: rm -rf go{{go_version}}.linux-amd64.tar.gz*

        - name: Add Go binary path to ~/.profile
          lineinfile:
            path: ~/.profile
            line: 'export PATH=$PATH:/usr/local/go/bin:$GOPATH/bin'
            create: true
            state: present

        - name: Source updated profile
          shell: . ~/.profile
      when: go_installed.stat.exists == false

    # test if nvm has been installed by the user desired
    - stat:
        path: "$HOME/.nvm"
      register: nvm_path

    - name: Setup NodeVersionManager and install node version
      block:
        - name: Install nvm
          shell: >
            curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v{{nvm_version}}/install.sh | bash 
          args:
            executable: /bin/bash
            chdir: "$HOME"
            creates: "$HOME/.nvm/nvm.sh"

        - name: Setup .profile of yournonrootuser
          lineinfile:
            path: ~/.profile
            # This will make sure Node is on the users PATH
            line: source ~/.nvm/nvm.sh 
            create: yes
      when: nvm_path.stat.exists  == false 

    - name: Installing node versions using loop
      shell: >
        source $HOME/.nvm/nvm.sh && nvm install {{item}}
      args:
        executable: /bin/bash
        chdir: "$HOME"
        creates: "$HOME/.nvm/versions/node/v{{item}}"
      loop:
        - 16
        # - 14.18.3